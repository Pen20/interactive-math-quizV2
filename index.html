<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Interactive Math Quiz</title>
    <link rel="stylesheet" href="css/style.css" />
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script
      id="MathJax-script"
      async
      src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"
    ></script>
  </head>
  <body>
    <script>
      // Require login before using the app: redirect to auth page if no token
      (function () {
        try {
          const token = localStorage.getItem('auth_token');
          if (!token) {
            // preserve intended destination after login if desired
            const dest = encodeURIComponent(location.pathname + location.search);
            location.replace('/html/auth/login.html?next=' + dest);
          }
        } catch (e) {
          // if storage is not available, still redirect to login
          location.replace('/html/auth/login.html');
        }
      })();
    </script>
    <div class="container">
      <header>
        <div class="header-main">
          <div>
            <h1>Interactive Math Quiz</h1>
            <p>Practice and master mathematical concepts with AI-powered feedback</p>
          </div>
          <div id="user-area" class="user-area">
            <!-- Filled by client script: user name and sign out button -->
          </div>
        </div>
      </header>

      <!-- Add inside the main card grid on index.html -->
      <div class="quiz-card">
        <div class="quiz-icon"></div>
        <h3>Differential Calculus</h3>
        <p>Four focused quizzes on derivatives.</p>
        <a class="button primary" href="/html/differential/">Open</a>
      </div>

      <div class="quiz-card">
        <div class="quiz-icon"></div>
        <h3>Linear Algebra</h3>
        <p>3 focused questions on linear algebra.</p>
        <a class="button primary" href="/html/linear-algebra/">Open</a>
      </div>

      <div class="api-config">
        <h3>OpenAI Configuration</h3>
        <div class="config-form">
          <!-- <input
            type="password"
            id="openai-key"
            placeholder="Enter your OpenAI API key"
            class="api-input"
          /> -->
          <select id="gpt-model" class="model-select">
            <option value="gpt-4o-mini">GPT-4o-mini</option>
            <option value="gpt-4o">GPT-4o</option>
            <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
          </select>
          <button id="save-config" class="config-button">
            Save Configuration
          </button>
        </div>
        <p class="config-note">
          Your device stores only the selected model. The OpenAI key is kept
          securely on the server.
        </p>
        <p>
          <a class="button" href="/html/auth/login.html">Sign In / Sign Up</a>
        </p>
      </div>
    </div>

    <script src="js/app.js"></script>
    <script>
      // Populate user area in header
      (function () {
        try {
          const ua = document.getElementById('user-area');
          const userRaw = localStorage.getItem('auth_user');
          if (!ua) return;
          if (userRaw) {
            let user = {};
            try { user = JSON.parse(userRaw); } catch (e) { user = {}; }
            const name = user.name || user.email || 'User';
            ua.innerHTML = `<span class="user-name">${name}</span> <button id="signout-btn" class="button secondary">Sign out</button>`;
            document.getElementById('signout-btn').addEventListener('click', () => {
              if (window.auth && typeof window.auth.signOut === 'function') return window.auth.signOut();
              localStorage.removeItem('auth_token'); localStorage.removeItem('auth_user'); location.replace('/html/auth/login.html');
            });
          } else {
            ua.innerHTML = `<a class="button" href="/html/auth/login.html">Sign In</a>`;
          }
        } catch (e) {
          // ignore
        }
      })();
    </script>
    <script>
      const modelEl = document.getElementById("gpt-model");
      const savedModel = localStorage.getItem("openai_model");
      if (savedModel) modelEl.value = savedModel;

      document.getElementById("save-config").addEventListener("click", () => {
        window.openAIService.initialize(modelEl.value);
        alert("Model saved.");
      });
    </script>
  </body>
</html>
